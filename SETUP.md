# Wazbot Setup Guide

## Prerequisites

- Node.js v18+ installed
- npm or pnpm package manager
- Convex account (free at https://convex.dev)

## Step 1: Install Dependencies

```bash
npm install
```

## Step 2: Initialize Convex (Interactive)

Since Convex requires interactive setup, you'll need to run this in your local terminal:

```bash
npx convex dev
```

This will:

1. Prompt you to log in to Convex (or create an account)
2. Ask if you want to create a new project or use an existing one
3. Set up your development deployment
4. Generate TypeScript types in `convex/_generated/`
5. Auto-create `.env.local` with your `CONVEX_DEPLOYMENT` value
6. Display your `CONVEX_URL` in the terminal

**What to choose:**

- **"What would you like to configure?"** → Choose `Create a new project`
- **Project name:** → Enter `wazbot` (or your preferred name)
- **Team:** → Choose your team or create a new one

## Step 3: Update Environment Variables

After running `npx convex dev`, you'll see output like:

```
✔ Deployment URL: https://happy-animal-123.convex.cloud
```

Copy this URL and update your `.env` file:

```bash
# .env
CONVEX_URL=https://happy-animal-123.convex.cloud
CONVEX_DEPLOYMENT=dev:happy-animal-123
OWNER_ID=  # Leave empty for now, we'll set this up next
```

The `.env.local` file will be auto-generated with the `CONVEX_DEPLOYMENT` value.

## Step 4: Create a Test User in Convex

Once your Convex deployment is running:

1. Open the Convex Dashboard: https://dashboard.convex.dev
2. Navigate to your `wazbot` project
3. Go to the **Data** tab
4. Find the `users` table
5. Click **Add Document** and create a test user:

```json
{
  "clerkId": "test_user_123",
  "email": "owner@example.com"
}
```

6. Copy the generated `_id` (looks like `kg21234567890abcdef`)
7. Update `.env` with this ID:

```bash
OWNER_ID=kg21234567890abcdef
```

## Step 5: Create a Session

With `npx convex dev` still running, create a session for your user:

1. In the Convex Dashboard, go to **Functions** tab
2. Find `sessions:create` mutation
3. Run it with:

```json
{
  "ownerId": "kg21234567890abcdef"
}
```

This will create a session document that the WhatsApp worker will use.

## Step 6: Start the WhatsApp Worker

Now you can start the worker in a separate terminal:

```bash
cd worker
npm run dev
# or
node index.ts
```

Or if using TypeScript directly:

```bash
npx tsx worker/index.ts
```

The worker will:

1. Connect to Convex
2. Initialize WhatsApp Web client
3. Generate a QR code in the terminal
4. Wait for you to scan it with WhatsApp mobile app

## Step 7: Scan QR Code

1. Open WhatsApp on your phone
2. Go to **Settings** → **Linked Devices**
3. Tap **Link a Device**
4. Scan the QR code shown in the terminal
5. Wait for "READY" message confirming connection

## Verification

Once connected, you should see:

- In terminal: `READY` and owner details logged
- In Convex Dashboard: Session status changed to `CONNECTED`
- Owner WID and phone number populated in the session document

## Troubleshooting

**"Cannot prompt for input in non-interactive terminals"**

- Make sure you're running `npx convex dev` in a regular terminal (not through an IDE task or non-interactive shell)
- Try running it in Windows Terminal, PowerShell, or Command Prompt directly

**"No CONVEX_DEPLOYMENT set"**

- Make sure `.env.local` exists and contains `CONVEX_DEPLOYMENT`
- This file is auto-generated by `npx convex dev`

**"AUTHENTICATION FAILURE"**

- The session may have expired
- Delete `.wwebjs_auth/` folder and restart the worker to get a fresh QR code

**"OWNER_ID not found"**

- Make sure you created a user in the `users` table
- Verify the ID format matches (should start with a letter, not numbers)

## Next Steps

Once everything is running:

- Send `$start` from the owner's WhatsApp number to test the bot
- Check Convex Dashboard for message logs
- Explore the directives in `directives/` folder to understand the system architecture

## Development Workflow

For ongoing development:

1. **Terminal 1:** `npx convex dev` (keeps types updated and pushes schema changes)
2. **Terminal 2:** `npx tsx worker/index.ts` (runs WhatsApp worker)
3. Edit code in `convex/` or `worker/` as needed
4. Convex auto-reloads, worker needs manual restart

---

**Need help?** Check the architecture docs:

- `directives/whatsapp_saas_architecture.md`
- `directives/whatsapp_session_layer.md`
- `CLAUDE.md` for system design principles
